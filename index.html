<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ¤– Alice - Jarvis Klon</title>
    <script src="https://unpkg.com/livekit-client@1.15.13/dist/livekit-client.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #0f1419 0%, #1a2332 100%);
            color: white;
            height: 100vh;
            overflow: hidden;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .title {
            font-size: 3em;
            font-weight: 300;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #4a9eff, #00d4aa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            font-size: 1.2em;
            opacity: 0.7;
        }
        
        .video-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        #remoteVideo {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 20px;
        }
        
        .avatar {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            background: linear-gradient(45deg, #4a9eff, #00d4aa);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4em;
        }
        
        .controls {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 15px 30px;
            border: none;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 500;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }
        
        .btn.primary {
            background: linear-gradient(45deg, #4a9eff, #00d4aa);
        }
        
        .btn.danger {
            background: linear-gradient(45deg, #ff6b6b, #ffa726);
        }
        
        .status {
            text-align: center;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .status.connected {
            background: rgba(0, 212, 170, 0.2);
            border: 1px solid rgba(0, 212, 170, 0.3);
        }
        
        .status.connecting {
            background: rgba(255, 167, 38, 0.2);
            border: 1px solid rgba(255, 167, 38, 0.3);
        }
        
        .status.disconnected {
            background: rgba(255, 107, 107, 0.2);
            border: 1px solid rgba(255, 107, 107, 0.3);
        }
        
        .chat {
            height: 200px;
            overflow-y: auto;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            font-family: 'SF Mono', Consolas, monospace;
            font-size: 0.9em;
            line-height: 1.4;
        }
        
        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
        }
        
        .chat-message.user {
            background: rgba(74, 158, 255, 0.3);
            text-align: right;
        }
        
        .chat-message.alice {
            background: rgba(0, 212, 170, 0.3);
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title">ðŸ¤– Alice</div>
            <div class="subtitle">Din Svenska AI-Assistent â€¢ Jarvis Klon med Lokal AI</div>
        </div>
        
        <div class="status disconnected" id="status">
            <strong>Status:</strong> <span id="statusText">Ej ansluten</span>
        </div>
        
        <div class="video-container" id="videoContainer">
            <div class="avatar">ðŸ¤–</div>
            <video id="remoteVideo" class="hidden" autoplay muted></video>
        </div>
        
        <div class="controls">
            <button class="btn primary" id="connectBtn">Anslut till Alice</button>
            <button class="btn" id="micBtn">ðŸŽ¤ Mikrofon</button>
            <button class="btn danger hidden" id="disconnectBtn">Koppla frÃ¥n</button>
        </div>
        
        <div class="chat" id="chat">
            <div class="chat-message alice">
                <strong>[Alice]:</strong> VÃ¤ntar pÃ¥ anslutning...
            </div>
        </div>
    </div>

    <script>
        // LiveKit konfiguration fÃ¶r lokal server
        const LIVEKIT_URL = 'ws://localhost:7880';
        const ROOM_NAME = 'alice-room';
        const PARTICIPANT_NAME = 'User-' + Math.random().toString(36).substr(2, 9);
        
        // LiveKit objekt
        let room;
        let audioTrack;
        let videoTrack;
        
        // DOM element
        const statusEl = document.getElementById('status');
        const statusTextEl = document.getElementById('statusText');
        const connectBtn = document.getElementById('connectBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const micBtn = document.getElementById('micBtn');
        const videoContainer = document.getElementById('videoContainer');
        const remoteVideo = document.getElementById('remoteVideo');
        const chatEl = document.getElementById('chat');
        
        // Status-hantering
        function updateStatus(status, text) {
            statusEl.className = `status ${status}`;
            statusTextEl.textContent = text;
        }
        
        // Chat-meddelanden
        function addMessage(sender, message) {
            const div = document.createElement('div');
            div.className = `chat-message ${sender.toLowerCase()}`;
            div.innerHTML = `<strong>[${sender}]:</strong> ${message}`;
            chatEl.appendChild(div);
            chatEl.scrollTop = chatEl.scrollHeight;
        }
        
        // Generera JWT token fÃ¶r lokal utveckling
        function generateToken() {
            // Detta Ã¤r en utvecklingstoken - anvÃ¤nd riktiga nycklar i produktion
            const header = btoa(JSON.stringify({
                "alg": "HS256",
                "typ": "JWT"
            }));
            
            const payload = btoa(JSON.stringify({
                "iss": "devkey",
                "sub": PARTICIPANT_NAME,
                "name": PARTICIPANT_NAME,
                "room": ROOM_NAME,
                "exp": Math.floor(Date.now() / 1000) + (60 * 60), // 1 timme
                "nbf": Math.floor(Date.now() / 1000),
                "iat": Math.floor(Date.now() / 1000)
            }));
            
            // Enkel signatur fÃ¶r dev (inte sÃ¤ker fÃ¶r produktion)
            const signature = btoa("dev-signature");
            
            return `${header}.${payload}.${signature}`;
        }
        
        // Anslut till LiveKit
        async function connect() {
            try {
                updateStatus('connecting', 'Ansluter till Alice...');
                connectBtn.disabled = true;
                
                room = new LiveKit.Room();
                
                // Event listeners
                room.on(LiveKit.RoomEvent.Connected, () => {
                    updateStatus('connected', 'Ansluten till Alice');
                    addMessage('System', 'Ansluten till Alice! SÃ¤g nÃ¥got...');
                    connectBtn.classList.add('hidden');
                    disconnectBtn.classList.remove('hidden');
                });
                
                room.on(LiveKit.RoomEvent.Disconnected, () => {
                    updateStatus('disconnected', 'FrÃ¥nkopplad');
                    addMessage('System', 'FrÃ¥nkopplad frÃ¥n Alice');
                    connectBtn.classList.remove('hidden');
                    disconnectBtn.classList.add('hidden');
                    connectBtn.disabled = false;
                });
                
                room.on(LiveKit.RoomEvent.TrackSubscribed, (track, publication, participant) => {
                    if (track.kind === 'video') {
                        track.attach(remoteVideo);
                        document.querySelector('.avatar').style.display = 'none';
                        remoteVideo.classList.remove('hidden');
                    }
                });
                
                room.on(LiveKit.RoomEvent.DataReceived, (payload, participant) => {
                    const message = new TextDecoder().decode(payload);
                    addMessage('Alice', message);
                });
                
                // Anslut till rummet
                const token = generateToken();
                await room.connect(LIVEKIT_URL, token);
                
                // Aktivera mikrofon
                audioTrack = await LiveKit.createLocalAudioTrack();
                await room.localParticipant.publishTrack(audioTrack);
                
            } catch (error) {
                console.error('Anslutningsfel:', error);
                updateStatus('disconnected', 'Anslutning misslyckades');
                addMessage('System', `Fel: ${error.message}`);
                connectBtn.disabled = false;
            }
        }
        
        // Koppla frÃ¥n
        function disconnect() {
            if (room) {
                room.disconnect();
                room = null;
            }
            
            if (audioTrack) {
                audioTrack.stop();
                audioTrack = null;
            }
            
            document.querySelector('.avatar').style.display = 'flex';
            remoteVideo.classList.add('hidden');
        }
        
        // Event listeners
        connectBtn.addEventListener('click', connect);
        disconnectBtn.addEventListener('click', disconnect);
        
        // Mikrofon toggle (implementeras senare)
        micBtn.addEventListener('click', () => {
            if (audioTrack) {
                const enabled = audioTrack.isMuted;
                audioTrack.setMuted(!enabled);
                micBtn.textContent = enabled ? 'ðŸŽ¤ Mikrofon' : 'ðŸ”‡ Mikrofon av';
            }
        });
    </script>
</body>
</html>