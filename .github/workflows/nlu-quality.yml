name: NLU Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  nlu-accuracy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: 3.9
    
    - name: Install dependencies
      run: |
        cd server
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Run NLU Accuracy Test
      id: nlu_test
      run: |
        cd server
        python stress_test_nlu.py > nlu_results.txt 2>&1
        echo "NLU Test Results:" 
        cat nlu_results.txt
        
        # Extract accuracy percentage
        ACCURACY=$(grep "ðŸŽ¯ Accuracy:" nlu_results.txt | grep -o "[0-9]*\.[0-9]*%" | head -1)
        ACCURACY_NUM=$(echo $ACCURACY | sed 's/%//')
        
        echo "accuracy=$ACCURACY" >> $GITHUB_OUTPUT
        echo "accuracy_num=$ACCURACY_NUM" >> $GITHUB_OUTPUT
        
        # Set threshold (85% minimum)
        THRESHOLD=85.0
        echo "threshold=$THRESHOLD" >> $GITHUB_OUTPUT
        
        # Check if accuracy meets threshold
        if (( $(echo "$ACCURACY_NUM >= $THRESHOLD" | bc -l) )); then
          echo "status=PASS" >> $GITHUB_OUTPUT
          echo "âœ… NLU Accuracy $ACCURACY meets threshold of ${THRESHOLD}%"
        else
          echo "status=FAIL" >> $GITHUB_OUTPUT
          echo "âŒ NLU Accuracy $ACCURACY below threshold of ${THRESHOLD}%"
          exit 1
        fi
    
    - name: Report NLU Accuracy in Summary
      run: |
        echo "## ðŸ§  NLU Swedish Accuracy Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| Metric | Value | Status |" >> $GITHUB_STEP_SUMMARY
        echo "|--------|--------|--------|" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.nlu_test.outputs.status }}" = "PASS" ]; then
          echo "| **Swedish NLU Accuracy** | **${{ steps.nlu_test.outputs.accuracy }}** | âœ… **PASS** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | ${{ steps.nlu_test.outputs.threshold }}% | âœ… Met |" >> $GITHUB_STEP_SUMMARY
        else
          echo "| **Swedish NLU Accuracy** | **${{ steps.nlu_test.outputs.accuracy }}** | âŒ **FAIL** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Threshold** | ${{ steps.nlu_test.outputs.threshold }}% | âŒ Not Met |" >> $GITHUB_STEP_SUMMARY
        fi
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“Š Performance Metrics" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Minimum Threshold**: ${{ steps.nlu_test.outputs.threshold }}%" >> $GITHUB_STEP_SUMMARY
        echo "- **Actual Accuracy**: ${{ steps.nlu_test.outputs.accuracy }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Type**: Swedish Voice Commands" >> $GITHUB_STEP_SUMMARY
        echo "- **Test Suite**: Alice NLU Stress Test" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.nlu_test.outputs.status }}" = "PASS" ]; then
          echo "ðŸŽ¯ **Swedish NLU system meets production quality standards!**" >> $GITHUB_STEP_SUMMARY
        else
          echo "âš ï¸ **Swedish NLU accuracy needs improvement before merge.**" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: Upload NLU Test Results
      uses: actions/upload-artifact@v4
      with:
        name: nlu-test-results
        path: server/nlu_results.txt