<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🎯 Simple Streaming Test</title>
    <style>
        body {
            font-family: monospace;
            background: #111;
            color: #0ff;
            padding: 20px;
            line-height: 1.6;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .status {
            padding: 10px;
            border: 1px solid #0ff;
            margin-bottom: 20px;
            border-radius: 5px;
        }
        .controls {
            margin-bottom: 20px;
        }
        button {
            background: #333;
            color: #0ff;
            border: 1px solid #0ff;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            border-radius: 3px;
        }
        button:hover {
            background: #0ff;
            color: #111;
        }
        .log {
            background: #222;
            padding: 10px;
            height: 400px;
            overflow-y: auto;
            border: 1px solid #0ff;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        .metric {
            background: #333;
            padding: 8px;
            border-radius: 3px;
            text-align: center;
            font-size: 12px;
        }
        .metric-value {
            font-size: 16px;
            font-weight: bold;
            color: #0f0;
        }
        .metric-value.fail {
            color: #f00;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🎯 Alice Simple Streaming Test</h1>
        <p>Test streaming metrics via Voice Gateway WebSocket</p>
        
        <div class="status" id="status">
            Status: Disconnected
        </div>
        
        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="latency">-</div>
                <div>Total Latency</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="sloPass">-</div>
                <div>SLO Pass</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="turns">0</div>
                <div>Turns Tested</div>
            </div>
        </div>
        
        <div class="controls">
            <button onclick="connect()">🔌 Connect</button>
            <button onclick="testStreaming()">🎯 Test Streaming</button>
            <button onclick="testQuickPhrase('Hello Alice')">💬 "Hello Alice"</button>
            <button onclick="testQuickPhrase('What time is it?')">⏰ "What time?"</button>
            <button onclick="clearLog()">Clear Log</button>
        </div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        let websocket = null;
        let turnsCompleted = 0;
        let lastMetrics = null;

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function updateStatus(status) {
            document.getElementById('status').textContent = `Status: ${status}`;
        }

        function updateMetrics(metrics) {
            if (!metrics) return;
            
            const latency = metrics.total_latency_ms || 0;
            const sloPass = metrics.slo_pass;
            
            document.getElementById('latency').textContent = `${latency.toFixed(0)}ms`;
            document.getElementById('sloPass').textContent = sloPass ? '✅ PASS' : '❌ FAIL';
            document.getElementById('sloPass').className = `metric-value ${sloPass ? '' : 'fail'}`;
            document.getElementById('turns').textContent = turnsCompleted;
            
            lastMetrics = metrics;
        }

        function connect() {
            try {
                log('🔗 Connecting to voice gateway...');
                websocket = new WebSocket('ws://127.0.0.1:8001/ws/voice-stream/streaming_test');
                
                websocket.onopen = () => {
                    log('✅ Connected to streaming voice pipeline');
                    updateStatus('Connected');
                };
                
                websocket.onmessage = (event) => {
                    const message = JSON.parse(event.data);
                    handleStreamMessage(message);
                };
                
                websocket.onclose = () => {
                    log('🔌 Disconnected from streaming voice pipeline');
                    updateStatus('Disconnected');
                    websocket = null;
                };
                
                websocket.onerror = (error) => {
                    log('❌ WebSocket error: ' + error);
                    updateStatus('Error');
                };
            } catch (error) {
                log('❌ Connection failed: ' + error.message);
                updateStatus('Failed');
            }
        }

        function handleStreamMessage(message) {
            switch (message.type) {
                case 'processing_started':
                    log(`🤖 Processing: "${message.transcript}"`);
                    updateStatus('Processing...');
                    break;
                    
                case 'response_complete':
                    log(`✅ Response: "${message.response}"`);
                    updateStatus('Connected');
                    turnsCompleted++;
                    break;
                    
                case 'metrics':
                    log(`📊 Metrics received: ${JSON.stringify(message.data)}`);
                    updateMetrics(message.data);
                    break;
                    
                case 'error':
                    log(`❌ Error: ${message.message}`);
                    updateStatus('Error');
                    break;
                    
                default:
                    log(`📨 ${message.type}: ${JSON.stringify(message)}`);
            }
        }

        async function testStreaming() {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('❌ Not connected. Click Connect first.');
                return;
            }
            
            log('🎯 Testing streaming pipeline with simulated conversation...');
            
            // Simulate a conversation turn with timing
            const testPhrases = [
                'Hello Alice',
                'What time is it?',
                'How are you today?', 
                'Tell me a joke',
                'What is 2 plus 2?'
            ];
            
            for (const phrase of testPhrases) {
                await testQuickPhrase(phrase);
                await new Promise(resolve => setTimeout(resolve, 2000)); // 2s pause between tests
            }
            
            log('✅ Streaming test completed');
        }

        async function testQuickPhrase(phrase) {
            if (!websocket || websocket.readyState !== WebSocket.OPEN) {
                log('❌ Not connected. Click Connect first.');
                return;
            }
            
            log(`🎤 Testing phrase: "${phrase}"`);
            
            // Send transcript to voice gateway for processing
            websocket.send(JSON.stringify({
                type: 'partial_transcript',
                transcript: phrase,
                is_final: true,
                confidence: 1.0,
                test_mode: true  // Indicates this is a test, not real audio
            }));
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        // Auto-connect on page load
        window.addEventListener('load', () => {
            log('🚀 Simple Streaming Test loaded');
            log('📋 This tests streaming metrics without WebRTC complexity');
            log('🎯 Tests OpenAI Realtime pipeline via WebSocket');
            connect();
        });
    </script>
</body>
</html>