<!DOCTYPE html>
<html>
<head>
    <title>Mic Button Test</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #111; color: #fff; }
        .test-result { margin: 10px 0; padding: 10px; background: #333; border-radius: 5px; }
        .success { background: #155724; color: #d4edda; }
        .error { background: #721c24; color: #f8d7da; }
        .info { background: #0c5460; color: #d4edda; }
    </style>
</head>
<body>
    <h1>🎤 Alice Mic Button Test</h1>
    <div id="results"></div>
    
    <script>
        function addResult(level, message, data = {}) {
            const div = document.createElement('div');
            div.className = `test-result ${level}`;
            div.innerHTML = `<strong>${message}</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;
            document.getElementById('results').appendChild(div);
            console.log(message, data);
        }
        
        addResult('info', '🧪 Starting WebSocket test...');
        
        const ws = new WebSocket('ws://127.0.0.1:8000/ws/alice');
        const startTime = Date.now();
        
        ws.onopen = () => {
            const connectionTime = Date.now() - startTime;
            addResult('success', '✅ WebSocket connected!', { connectionTime: connectionTime + 'ms' });
            
            // Send test ping
            const ping = { type: 'ping', timestamp: Date.now() };
            ws.send(JSON.stringify(ping));
            addResult('info', '📤 Sent ping', ping);
            
            // Close after 3 seconds
            setTimeout(() => {
                ws.close(1000, 'test-complete');
            }, 3000);
        };
        
        ws.onmessage = (event) => {
            let data = event.data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {}
            
            addResult('info', '📨 Received message', data);
        };
        
        ws.onerror = (event) => {
            addResult('error', '❌ WebSocket error', { event: event.type });
        };
        
        ws.onclose = (event) => {
            const totalTime = Date.now() - startTime;
            addResult('info', '🔌 WebSocket closed', {
                code: event.code,
                reason: event.reason,
                wasClean: event.wasClean,
                totalTime: totalTime + 'ms'
            });
        };
        
        // Test browser capabilities
        setTimeout(() => {
            addResult('info', '🔧 Browser capabilities', {
                WebSocket: typeof WebSocket !== 'undefined',
                getUserMedia: !!(navigator.mediaDevices?.getUserMedia),
                SpeechRecognition: !!(window.SpeechRecognition || window.webkitSpeechRecognition),
                AudioContext: !!(window.AudioContext || window.webkitAudioContext),
                isSecureContext: window.isSecureContext,
                protocol: window.location.protocol
            });
        }, 1000);
    </script>
</body>
</html>